<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FutMaster ‚Äî v3.9 (Racha) - Sincronizado</title>

<style>
/* style.css - FutMaster v3.9 (final) */
:root{
  --bg1:#c9a85a; --bg2:#b8925a; --panel:#0b0b0b; --gold:#b8860b; --muted:#4b3d2a; --text-dark:#111; --card:#f3e7cf;
  font-family: Inter, system-ui, -apple-serif, "Segoe UI", Roboto, Arial, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text-dark)}
.container{max-width:1200px;margin:18px auto;padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.02));box-shadow:0 8px 30px rgba(0,0,0,0.08)}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.title{font-size:20px;font-weight:800;color:var(--panel);letter-spacing:0.6px}
.subtitle{color:var(--muted);font-size:13px}
.top-controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
input[type="text"], input[type="search"]{padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);min-width:220px}
button{background:var(--panel);color:var(--gold);border:2px solid var(--gold);padding:9px 12px;border-radius:8px;font-weight:700;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--panel);padding:8px}
.small{font-size:13px;color:var(--muted)}
.layout{display:grid;grid-template-columns: 1fr 360px;gap:16px}
@media (max-width:980px){ .layout{grid-template-columns:1fr} }
.left-panel{display:flex;flex-direction:column;gap:12px}
.panel{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06)}
.queue-list{max-height:420px;overflow:auto;margin-top:8px;display:flex;flex-direction:column;gap:8px}
.row{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:linear-gradient(90deg,rgba(255,255,255,0.6),rgba(255,255,255,0.95));border:1px solid rgba(0,0,0,0.04)}
.pos{width:40px;color:var(--muted);text-align:center}
.name{flex:1;font-weight:700;color:var(--text-dark)}
.actions{display:flex;gap:6px}
.teams{display:flex;flex-direction:column;gap:12px}
.team-card{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.98),rgba(255,255,255,0.96));border:2px solid rgba(0,0,0,0.04)}
.team-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:800;color:var(--panel)}
.team-heading{font-size:16px}
.team-players{display:flex;flex-direction:column;gap:6px;min-height:60px;padding:6px;border-radius:6px;border:1px dashed rgba(0,0,0,0.04)}
.player-item{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;background:linear-gradient(90deg, rgba(234,223,208,0.6), rgba(234,223,208,0.85));border:1px solid rgba(0,0,0,0.03)}
.player-role{width:28px;color:var(--muted);text-align:center}
.player-name{flex:1;font-weight:800;color:var(--panel)}
.timer-bottom { margin-top:20px; text-align:center; padding:14px; background: linear-gradient(180deg, rgba(0,0,0,0.05), rgba(0,0,0,0.03)); border-radius:12px; border:2px solid rgba(0,0,0,0.04); }
.timer-big { font-size:72px; font-weight:900; color:#000; text-shadow: 0 0 0 #000, 0 0 10px var(--gold); margin:6px 0; -webkit-text-stroke:2px #b8860b; }
.tiny{padding:6px 8px;border-radius:8px;font-size:13px;background:transparent;border:1px solid rgba(0,0,0,0.04)}
.badge-incomplete{color:var(--panel);font-weight:700;background:linear-gradient(90deg,#fff,#f3e7cf);padding:2px 6px;border-radius:6px;border:1px solid rgba(0,0,0,0.05)}
.footer{display:flex;flex-direction:column;align-items:center;gap:6px;margin-top:10px;color:var(--muted)}
.drag-over { outline: 3px dashed rgba(0,0,0,0.2); }

/* --- üåü CORES DE STATUS (REVISADO v3.9) üåü --- */
/* Amarelo para Times Jogando (A e B) */
.team-heading.status-playing-yellow { 
    font-weight:900; 
    color: #111;
    background-color: #ffd700; /* Amarelo Forte */
    padding: 3px 8px;
    border-radius: 4px;
} 
/* Azul para o Pr√≥ximo Time (C) */
.team-heading.status-next-blue { 
    font-weight:900; 
    color: #fff;
    background-color: #1e90ff; /* Azul Forte */
    padding: 3px 8px;
    border-radius: 4px;
} 
/* Quase Branco/Cinza Claro para Times Aguardando */
.team-heading.status-waiting-white { 
    font-weight:700; 
    color: #555;
    background-color: #f3f3f3; /* Cinza Suave (Quase Branco) */
    padding: 3px 8px;
    border-radius: 4px;
} 

.team-status { font-weight:800; margin-left:6px; }

@media (max-width:600px){
  .timer-big{font-size:44px}
  input[type="text"]{min-width:140px}
  .container{padding:12px;margin:8px}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">FutMaster ‚Äî Racha</div>
      <div class="subtitle">v3.9 ‚Äî Online / Colaborativo</div>
    </div>
    <div class="small">Status: <span id="firebaseStatus" style="font-weight:700">Conectando...</span></div>
  </div>

  <div class="top-controls">
    <input id="inputPlayer" placeholder="Nome do jogador e Enter" />
    <button id="btnAdd">Adicionar (ir para final)</button>
    <button id="btnFormTeams" class="btn-ghost">Sortear 10 primeiros e formar A/B</button>
    <button id="btnGroup5" class="btn-ghost">Formar restantes em times (5 + incompletos)</button>
    <button id="btnMakeNext" class="btn-ghost">Puxar pr√≥ximo time (5)</button>
    <button id="btnReset" class="btn-ghost">Nova Noite (limpar tudo)</button>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <label class="small"><input type="checkbox" id="chkClearOnLoad"> Limpar pagamentos ao abrir</label>
    </div>
  </div>

  <div class="layout">
    <div class="left-panel">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Fila de Jogadores (ordem de chegada)</div>
          <div class="small">Total: <span id="countQueue">0</span></div>
        </div>
        <div class="queue-list" id="queueList" ondragover="allowDrop(event)" ondrop="onDropToQueue(event)"></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnShuffle" class="tiny">Embaralhar</button>
          <button id="btnExport" class="tiny">Exportar (texto)</button>
          <button id="btnImport" class="tiny">Importar (colar)</button>
        </div>
      </div>

      <div class="panel teams">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Times em Ordem (A ‚Üí Z)</div>
          <div class="small">A√ß√µes: mover time, puxar pr√≥ximos, registrar derrota</div>
        </div>

        <div id="teamsContainer"></div>

        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <button id="btnKeepWinner" class="tiny">Manter vencedor (padr√£o)</button>
          <div style="margin-left:auto" class="small">Times: <span id="countTeams">0</span></div>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Painel de Pagamentos</div>
          <div style="display:flex;gap:6px">
            <button id="btnClearPayments" class="tiny">Limpar pagamentos</button>
            <button id="btnExportPayments" class="tiny">Exportar</button>
          </div>
        </div>
        <div class="payments-list" id="paymentsList"></div>
        <div style="margin-top:10px" class="small">Marque quem j√° pagou a noite.</div>
      </div>
    </div>
  </div>

  <div class="timer-bottom">
    <div style="font-weight:800">Cron√¥metro ‚Äî Partida (7 minutos)</div>
    <div class="timer-big" id="timerDisplay">07:00</div>
    <div style="display:flex;justify-content:center;gap:8px;margin-top:8px">
      <button id="startBtn" class="tiny">Iniciar</button>
      <button id="pauseBtn" class="tiny">Pausar</button>
      <button id="resetBtnTimer" class="tiny">Resetar</button>
      <label style="align-self:center;margin-left:8px"><input type="checkbox" id="chkSound" checked> Som</label>
    </div>
    <div style="margin-top:10px">
      <button id="btnTestWhistle" style="background:var(--gold);color:#000;border:2px solid #000;padding:10px 14px;border-radius:8px;font-weight:800">Testar Apito</button>
      <div class="small" style="margin-top:6px;color:var(--muted)">Toque para ativar o som no navegador e testar o apito (recomendado antes do jogo).</div>
    <div>
  </div>

  <div class="footer">
    <div class="small">Apito de est√°dio embutido (sintetizado). Mantenha a aba ativa no celular para garantir reprodu√ß√£o.</div>
    <div class="small">Sincronizado em tempo real com Firebase.</div>
    <div style="font-weight:700;color:var(--gold)">FutMaster v3.9</div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
// app.js - FutMaster v3.9 (Nova L√≥gica de Times e Novo Apito)

// ----------------------------------------------------
// A. CONFIGURA√á√ÉO FIREBASE
// ----------------------------------------------------
const firebaseConfig = {
    apiKey: "AIzaSyAuKyiDOpKsq11iO0c7v8NvQYqVdbZr4Ko",
  authDomain: "futuriasmaster.firebaseapp.com",
  databaseURL: "https://futuriasmaster-default-rtdb.firebaseio.com",
  projectId: "futuriasmaster",
  storageBucket: "futuriasmaster.firebasestorage.app",
  messagingSenderId: "698635901166",
  appId: "1:698635901166:web:670975316797b14eb07bff",
  measurementId: "G-XLTG46ZKZP"
};

// Inicializa√ß√£o das vari√°veis Firebase
const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const dbRef = database.ref('futmaster_state'); 

// ----------------------------------------------------
// B. ESTADO E VARI√ÅVEIS GLOBAIS
// ----------------------------------------------------
let state = {
  playersQueue: [],
  teams: [],
  payments: {},
  clearPaymentsOnLoad: false,
  timerSeconds: 7 * 60,
  soundOn: true,
  timerRunning: false, 
  timerInterval: null 
};

let queueList, countQueue, teamsContainer, countTeams, paymentsList, timerDisplay, chkClearOnLoad, chkSound, firebaseStatus;

// ----------------------------------------------------
// C. FUN√á√ÉO DE APITO SINTETIZADO (Novo Som de Final de Jogo)
// ----------------------------------------------------

function playWhistleSound() {
    if (!state.soundOn) return;

    try {
        const audioContext = new(window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        const now = audioContext.currentTime;

        // Configura√ß√£o para um som mais longo e dram√°tico (3.5s)
        const duration = 3.5; 
        const startFreq = 880; // A5
        const endFreq = 440; // A4 (ligeira queda no final)

        oscillator.type = 'square'; 
        oscillator.frequency.setValueAtTime(startFreq, now); 
        oscillator.frequency.linearRampToValueAtTime(endFreq, now + duration); 

        // Controle de Volume: Fade in e Fade out
        gainNode.gain.setValueAtTime(0, now); 
        gainNode.gain.linearRampToValueAtTime(0.6, now + 0.1); // R√°pido fade in
        gainNode.gain.linearRampToValueAtTime(0.6, now + duration - 0.2); // Sustenta
        gainNode.gain.linearRampToValueAtTime(0, now + duration); // Fade out

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        oscillator.start(now);
        oscillator.stop(now + duration); 

    } catch (e) {
        console.warn('Web Audio API n√£o suportada ou erro ao iniciar.');
    }
}

// ----------------------------------------------------
// D. FUN√á√ïES FIREBASE (Sincroniza√ß√£o)
// ----------------------------------------------------

function pushStateToFirebase() {
  const stateToSave = { ...state
  };
  delete stateToSave.timerInterval;
  delete stateToSave.timerRunning;

  dbRef.set(stateToSave)
    .then(() => {
      firebaseStatus.textContent = 'Sincronizado';
    })
    .catch(error => {
      console.error("Erro ao salvar no Firebase:", error);
      firebaseStatus.textContent = 'Erro de Sincroniza√ß√£o';
      alert('Erro ao sincronizar com o Firebase. Verifique sua conex√£o e as Regras do Firebase.');
    });
}

function initFirebase() {
  firebaseStatus.textContent = 'Conectando...';

  dbRef.on('value', (snapshot) => {
    const data = snapshot.val();

    if (data) {
      updateStateAndRender(data);
      firebaseStatus.textContent = 'Online';
      
      const localTimer = localStorage.getItem('futmaster_timer_time');
      if (localTimer) state.timerSeconds = Number(localTimer);
    } else {
      // Otimiza√ß√£o para quando o banco est√° vazio: se houver dados locais (p√≥s AddPlayer), salva-os.
      if (state.playersQueue.length > 0 || state.teams.length > 0) {
          firebaseStatus.textContent = 'Inicializando com dados locais...';
          pushStateToFirebase();
      } else {
          firebaseStatus.textContent = 'Aguardando dados...';
      }
    }
  }, (error) => {
    console.error("Erro de leitura do Firebase:", error);
    firebaseStatus.textContent = 'ERRO! Verifique regras.';
  });
}

// ----------------------------------------------------
// E. FUN√á√ïES DE UTILIDADE E RENDERIZA√á√ÉO
// ----------------------------------------------------

function formatTime(s) {
  const m = Math.floor(s / 60).toString().padStart(2, '0');
  const sec = (s % 60).toString().padStart(2, '0');
  return `${m}:${sec}`;
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function escapeHtml(s = '') {
  return ('' + s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function initDOMRefs() {
  queueList = document.getElementById('queueList');
  countQueue = document.getElementById('countQueue');
  teamsContainer = document.getElementById('teamsContainer');
  countTeams = document.getElementById('countTeams');
  paymentsList = document.getElementById('paymentsList');
  timerDisplay = document.getElementById('timerDisplay');
  chkClearOnLoad = document.getElementById('chkClearOnLoad');
  chkSound = document.getElementById('chkSound');
  firebaseStatus = document.getElementById('firebaseStatus'); 
}

function updateStateAndRender(newState) {
  const localTimerRunning = state.timerRunning;
  const localTimerInterval = state.timerInterval;
  
  state = { ...state, ...newState };

  state.timerRunning = localTimerRunning;
  state.timerInterval = localTimerInterval;

  if (state.clearPaymentsOnLoad && !newState.payments) {
    state.payments = {};
    pushStateToFirebase(); 
  }

  renderAll();
}

function renderAll() {
  renderQueue();
  renderTeams();
  renderPayments();
  if(timerDisplay) timerDisplay.textContent = formatTime(state.timerSeconds); 
  if(chkClearOnLoad) chkClearOnLoad.checked = !!state.clearPaymentsOnLoad;
  if(chkSound) chkSound.checked = !!state.soundOn;
}

function renderQueue() {
  queueList.innerHTML = '';
  state.playersQueue.forEach((name, idx) => {
    const div = document.createElement('div');
    div.className = 'row';
    div.draggable = true;
    div.dataset.origin = 'queue';
    div.dataset.idx = idx;
    div.setAttribute('ondragstart', 'onDragStart(event)');
    div.innerHTML = `<div class="pos">${idx+1}</div><div class="name">${escapeHtml(name)}</div><div class="actions">
      <button class="tiny edit-queue" data-idx="${idx}">‚úèÔ∏è</button>
      <button class="tiny up-queue" data-idx="${idx}">üîº</button>
      <button class="tiny down-queue" data-idx="${idx}">üîΩ</button>
      <button class="tiny move-to-team" data-idx="${idx}">‚Ü™Ô∏è Mover</button>
      <button class="tiny remove-queue" data-idx="${idx}">üóëÔ∏è</button>
    </div>`;
    queueList.appendChild(div);
  });
  countQueue.textContent = state.playersQueue.length;
}

function renderTeams() {
  teamsContainer.innerHTML = '';
  state.teams.forEach((team, tIndex) => {
    const teamLabel = String.fromCharCode(65 + tIndex);
    let statusLabel = '',
      statusClass = '';
    
    // --- L√ìGICA DE STATUS VISUAL (CUSTOMIZADA) ---
    if (tIndex === 0) {
      statusLabel = 'Jogando (Time A)';
      statusClass = 'status-playing-yellow'; // AMARELO
    } else if (tIndex === 1) {
      statusLabel = 'Jogando (Time B)';
      statusClass = 'status-playing-yellow'; // AMARELO
    } else if (tIndex === 2) {
      statusLabel = 'Pr√≥ximo';
      statusClass = 'status-next-blue'; // AZUL
    } else {
      statusLabel = 'Aguardando';
      statusClass = 'status-waiting-white'; // BRANCO/CINZA
    }
    // --- ------------------------------- ---

    const card = document.createElement('div');
    card.className = 'team-card';

    const playersHtml = team.map((p, idx) => `<div class="player-item" draggable="true" data-origin="team" data-team="${tIndex}" data-idx="${idx}" ondragstart="onDragStart(event)">
      <div class="player-role">${idx+1}</div><div class="player-name">${escapeHtml(p)}</div>
      <div style="display:flex;gap:6px">
        <button class="tiny edit-team" data-team="${tIndex}" data-idx="${idx}">‚úèÔ∏è</button>
        <button class="tiny move-up-team" data-team="${tIndex}" data-idx="${idx}">üîº</button>
        <button class="tiny move-down-team" data-team="${tIndex}" data-idx="${idx}">üîΩ</button>
        <button class="tiny move-player" data-team="${tIndex}" data-idx="${idx}">‚ÜîÔ∏è Mover</button>
        <button class="tiny remove-team-player" data-team="${tIndex}" data-idx="${idx}">‚§µÔ∏è Fila</button>
      </div></div>`).join('') || '<div class="small">Vazio</div>';
      
    card.innerHTML = `<div class="team-title"><div class="team-heading ${statusClass}">Time ${teamLabel} ‚Äî <span class="team-status">${statusLabel}</span></div><div class="small">${team.length}/5</div></div><div class="team-players" data-teamindex="${tIndex}" ondragover="allowDrop(event)" ondrop="onDropToTeam(event, ${tIndex})">${playersHtml}</div>
      <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
        <button class="tiny btn-pull-next" data-team="${tIndex}">Puxar pr√≥ximo (5)</button>
        <button class="tiny btn-loser" data-team="${tIndex}">Time ${teamLabel} perdeu</button>
        <button class="tiny btn-move-up-card" data-team="${tIndex}">‚¨ÜÔ∏è Subir time</button>
        <button class="tiny btn-move-down-card" data-team="${tIndex}">‚¨áÔ∏è Descer time</button>
        <button class="tiny btn-move-to-pos" data-team="${tIndex}">‚ÜïÔ∏è Mover</button>
      </div>`;
    teamsContainer.appendChild(card);
  });
  countTeams.textContent = state.teams.length;
}

function renderPayments() {
  paymentsList.innerHTML = '';
  const allPlayers = [...new Set([...state.playersQueue, ...state.teams.flat()])].sort(); 
  
  allPlayers.forEach(name => {
    const checked = !!state.payments[name] ? 'checked' : '';
    const div = document.createElement('div');
    div.className = 'row payment-row';
    div.innerHTML = `<label style="display:flex;align-items:center;width:100%;gap:8px">
      <input type="checkbox" data-player="${escapeHtml(name)}" onchange="togglePayment(this)" ${checked}> 
      <div class="name" style="font-weight:600">${escapeHtml(name)}</div>
    </label>`;
    paymentsList.appendChild(div);
  });
}

// ----------------------------------------------------
// F. FUN√á√ïES DE A√á√ÉO
// ----------------------------------------------------

// Fun√ß√£o para mover time para posi√ß√£o espec√≠fica
function moveTeamCardToPos(sourceIndex, targetIndex) {
    if (sourceIndex === targetIndex || targetIndex < 0 || targetIndex >= state.teams.length) return;

    const [teamToMove] = state.teams.splice(sourceIndex, 1);
    state.teams.splice(targetIndex, 0, teamToMove);
    
    pushStateToFirebase();
}

function addPlayer(name) {
  const trimmedName = name.trim();
  const inputEl = document.getElementById('inputPlayer'); 

  if (trimmedName) {
      if (!state.playersQueue.includes(trimmedName)) {
          state.playersQueue.push(trimmedName); 
          pushStateToFirebase(); 
          if(inputEl) inputEl.value = '';
      }
  }
}

function togglePayment(checkbox) {
  const name = checkbox.dataset.player;
  if (checkbox.checked) {
    state.payments[name] = true;
  } else {
    delete state.payments[name];
  }
  pushStateToFirebase(); 
  renderPayments();
}

function handleGroup5() {
    const availablePlayers = [...state.playersQueue];
    state.playersQueue = [];

    let teamCount = 0;
    while (availablePlayers.length >= 5) {
        const newTeam = availablePlayers.splice(0, 5);
        state.teams.push(newTeam);
        teamCount++;
    }

    if (availablePlayers.length > 0) {
        state.teams.push(availablePlayers);
    }
    
    pushStateToFirebase();
    alert(`${teamCount} times de 5 formados. Sobraram ${availablePlayers.length} jogadores em um time incompleto (se houver).`);
}

function handleMakeNext() {
    const teamIndex = state.teams.length;
    if (state.playersQueue.length < 5) return alert('√â necess√°rio pelo menos 5 jogadores na fila.');

    const newTeam = state.playersQueue.splice(0, 5);
    state.teams.push(newTeam);
    
    pushStateToFirebase();
    alert(`Time ${String.fromCharCode(65 + teamIndex)} (5 jogadores) puxado para o final da ordem.`);
}

// Event Listeners (Corrigidos para robustez no AddPlayer)
document.getElementById('btnAdd').addEventListener('click', () => {
    const inputEl = document.getElementById('inputPlayer');
    addPlayer(inputEl ? inputEl.value : '');
});

document.getElementById('btnShuffle').addEventListener('click', () => {
    shuffle(state.playersQueue);
    pushStateToFirebase();
});

document.getElementById('btnFormTeams').addEventListener('click', () => {
  if (state.playersQueue.length < 10) return alert('√â necess√°rio pelo menos 10 jogadores na fila.');

  const playersToMove = state.playersQueue.splice(0, 10);
  shuffle(playersToMove);

  const teamA = playersToMove.slice(0, 5);
  const teamB = playersToMove.slice(5, 10);
  state.teams = [teamA, teamB];

  pushStateToFirebase(); 
});

document.getElementById('btnGroup5').addEventListener('click', handleGroup5);
document.getElementById('btnMakeNext').addEventListener('click', handleMakeNext);

document.getElementById('btnReset').addEventListener('click', () => {
  if (confirm('Tem certeza que deseja limpar a fila, times e pagamentos (Nova Noite)?')) {
    state.playersQueue = [];
    state.teams = [];
    state.payments = {};
    pushStateToFirebase(); 
  }
});

chkClearOnLoad.addEventListener('change', (e) => {
  state.clearPaymentsOnLoad = e.target.checked;
  pushStateToFirebase(); 
});

// Event Listener para a tecla Enter
document.getElementById('inputPlayer').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    const inputEl = document.getElementById('inputPlayer');
    addPlayer(inputEl ? inputEl.value : '');
    e.preventDefault(); 
  }
});


// Event listeners de cliques din√¢micos
document.addEventListener('click', (e) => {
    // L√≥gica para SUBIR TIME
    if (e.target.classList.contains('btn-move-up-card')) {
        const teamIndex = parseInt(e.target.dataset.team);
        moveTeamCardToPos(teamIndex, teamIndex - 1);
    }

    // L√≥gica para DESCER TIME
    if (e.target.classList.contains('btn-move-down-card')) {
        const teamIndex = parseInt(e.target.dataset.team);
        moveTeamCardToPos(teamIndex, teamIndex + 1);
    }
    
    // L√≥gica para MOVER TIME PARA POSI√á√ÉO ESPEC√çFICA
    if (e.target.classList.contains('btn-move-to-pos')) {
        const teamIndex = parseInt(e.target.dataset.team);
        const totalTeams = state.teams.length;
        const newPos = prompt(`Mover Time ${String.fromCharCode(65 + teamIndex)} para qual posi√ß√£o? (1 a ${totalTeams})`);
        
        if (newPos !== null) {
            const targetIndex = parseInt(newPos) - 1; 
            if (targetIndex >= 0 && targetIndex < totalTeams) {
                 moveTeamCardToPos(teamIndex, targetIndex);
            } else {
                 alert('Posi√ß√£o inv√°lida. Por favor, insira um n√∫mero entre 1 e ' + totalTeams);
            }
        }
    }

    // L√≥gica para mover time para o final (perdeu)
    if (e.target.classList.contains('btn-loser')) {
        const teamIndex = parseInt(e.target.dataset.team);
        if (state.teams.length > teamIndex) {
            const teamToMove = state.teams.splice(teamIndex, 1)[0];
            state.teams.push(teamToMove);
            pushStateToFirebase();
        }
    }
    // L√≥gica para remover jogador da fila
    if (e.target.classList.contains('remove-queue')) {
        const idx = parseInt(e.target.dataset.idx);
        state.playersQueue.splice(idx, 1);
        pushStateToFirebase();
    }
    // L√≥gica para mover jogador do time para a fila
    if (e.target.classList.contains('remove-team-player')) {
        const tIndex = parseInt(e.target.dataset.team);
        const pIndex = parseInt(e.target.dataset.idx);
        if (state.teams[tIndex] && state.teams[tIndex][pIndex]) {
            const player = state.teams[tIndex].splice(pIndex, 1)[0];
            state.playersQueue.push(player);
            pushStateToFirebase();
        }
    }
    // L√≥gica para limpar pagamentos
    if (e.target.id === 'btnClearPayments') {
        if (confirm('Tem certeza que deseja limpar todos os pagamentos da noite?')) {
            state.payments = {};
            pushStateToFirebase();
            renderPayments();
        }
    }
});


// ----------------------------------------------------
// G. L√ìGICA DO CRON√îMETRO (Local, com persist√™ncia b√°sica)
// ----------------------------------------------------

function startTimer() {
  if (state.timerRunning) return;
  state.timerRunning = true;
  state.timerInterval = setInterval(() => {
    if (state.timerSeconds > 0) {
      state.timerSeconds--;
      localStorage.setItem('futmaster_timer_time', state.timerSeconds); 
      if(timerDisplay) timerDisplay.textContent = formatTime(state.timerSeconds); 
    } else {
      clearInterval(state.timerInterval);
      state.timerRunning = false;
      if(timerDisplay) timerDisplay.textContent = "FIM!";
      if (state.soundOn) playWhistleSound();
    }
  }, 1000);
}

function pauseTimer() {
  clearInterval(state.timerInterval);
  state.timerRunning = false;
}

function resetTimer() {
  pauseTimer();
  state.timerSeconds = 7 * 60;
  localStorage.setItem('futmaster_timer_time', state.timerSeconds);
  if(timerDisplay) timerDisplay.textContent = formatTime(state.timerSeconds);
}

document.getElementById('startBtn').addEventListener('click', startTimer);
document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
document.getElementById('resetBtnTimer').addEventListener('click', resetTimer);
document.getElementById('btnTestWhistle').addEventListener('click', playWhistleSound);

if(chkSound) chkSound.addEventListener('change', (e) => state.soundOn = e.target.checked);


// ----------------------------------------------------
// H. FUN√á√ïES DYNAMIC DRAG AND DROP (D&D)
// ----------------------------------------------------

function allowDrop(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.add('drag-over');
}
document.addEventListener('dragenter', (ev) => {
    if (ev.target.classList.contains('queue-list') || ev.target.classList.contains('team-players')) {
        ev.target.classList.add('drag-over');
    }
});
document.addEventListener('dragleave', (ev) => {
    if (ev.target.classList.contains('drag-over')) {
        ev.target.classList.remove('drag-over');
    }
});

function onDragStart(ev) {
    const origin = ev.currentTarget.dataset.origin;
    const index = ev.currentTarget.dataset.idx;
    const teamIndex = ev.currentTarget.dataset.team;

    ev.dataTransfer.setData("origin", origin);
    ev.dataTransfer.setData("index", index);
    if (origin === 'team') {
        ev.dataTransfer.setData("teamIndex", teamIndex);
    }
    ev.currentTarget.classList.add('dragging'); 
}

function onDropToQueue(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.remove('drag-over');

    const origin = ev.dataTransfer.getData("origin");
    const index = parseInt(ev.dataTransfer.getData("index"));

    if (origin === 'team') {
        const teamIndex = parseInt(ev.dataTransfer.getData("teamIndex"));
        
        const player = state.teams[teamIndex].splice(index, 1)[0];
        state.playersQueue.push(player);

        pushStateToFirebase();
    }
}

function onDropToTeam(ev, targetTeamIndex) {
    ev.preventDefault();
    ev.currentTarget.classList.remove('drag-over');

    const origin = ev.dataTransfer.getData("origin");
    const index = parseInt(ev.dataTransfer.getData("index"));

    if (origin === 'queue') {
        const player = state.playersQueue.splice(index, 1)[0];
        
        if (!state.teams[targetTeamIndex]) {
            state.teams[targetTeamIndex] = [];
        }
        
        state.teams[targetTeamIndex].push(player);
        pushStateToFirebase();

    } else if (origin === 'team') {
        const sourceTeamIndex = parseInt(ev.dataTransfer.getData("teamIndex"));
        const player = state.teams[sourceTeamIndex].splice(index, 1)[0];
        
        const targetElement = ev.target.closest('.player-item');
        let dropIndex = state.teams[targetTeamIndex].length; 

        if (targetElement) {
            const dropPlayerIndex = parseInt(targetElement.dataset.idx);
            dropIndex = dropPlayerIndex;
            
            if (sourceTeamIndex === targetTeamIndex && dropPlayerIndex > index) {
                dropIndex = dropPlayerIndex - 1;
            }
        }
        
        state.teams[targetTeamIndex].splice(dropIndex, 0, player);
        pushStateToFirebase();
    }
}


// ----------------------------------------------------
// I. INICIALIZA√á√ÉO
// ----------------------------------------------------
window.onload = () => {
  initDOMRefs();
  initFirebase();
};
</script>
</body>
</html>
